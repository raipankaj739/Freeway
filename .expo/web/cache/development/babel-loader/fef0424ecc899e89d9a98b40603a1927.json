{"ast":null,"code":"import * as AppAuth from 'expo-app-auth';\nimport { CodedError } from '@unimodules/core';\nimport { Platform } from 'react-native';\nimport Constants from 'expo-constants';\nconst isInExpo = Constants.appOwnership === 'expo';\n\nfunction getPlatformGUID(config) {\n  const {\n    clientId\n  } = config;\n  const iosClientId = Constants.appOwnership === 'standalone' ? config.iosStandaloneAppClientId : config.iosClientId;\n  const androidClientId = isInExpo ? config.androidClientId : config.androidStandaloneAppClientId;\n  const platformClientId = Platform.select({\n    ios: iosClientId,\n    android: androidClientId,\n    default: config.clientId\n  }) || clientId;\n\n  if (typeof iosClientId === 'string' && typeof androidClientId === 'string' && iosClientId === androidClientId) {\n    throw new CodedError('ERR_GOOGLE_CONFIG', 'Keys for Android and iOS cannot be the same value. Ensure you are linking the client IDs matching the given platforms in the Google APIs console: https://console.developers.google.com/apis/credentials');\n  }\n\n  const guid = guidFromClientId(platformClientId);\n  return guid;\n} // TODO: Bacon: ensure this is valid for all cases.\n\n\nconst PROJECT_NUMBER_LENGTH = 11;\nconst PROJECT_ID_LENGTH = 32;\n\nfunction isValidGUID(guid) {\n  const components = guid.split('-');\n\n  if (components.length !== 2) {\n    return {\n      isValid: false,\n      reason: `\\`${guid}\\` must be a string of numbers and an alphanumeric string ${PROJECT_ID_LENGTH} characters long, joined with a hyphen.`\n    };\n  }\n\n  const projectNumber = components[0];\n  const projectId = components[1];\n\n  if (isNaN(+projectNumber)) {\n    const hashedProjectId = Array(PROJECT_ID_LENGTH).fill('x');\n    return {\n      isValid: false,\n      reason: `\\`${projectNumber}-${hashedProjectId}\\` project number must be a string of numbers.`\n    };\n  }\n\n  if (!projectId.match('^[a-zA-Z0-9]+$')) {\n    const hashedProjectNumber = Array(projectNumber.length).fill('x');\n    return {\n      isValid: false,\n      reason: `\\`${hashedProjectNumber}-${projectId}\\` project ID must be an alphanumeric string ${PROJECT_ID_LENGTH} characters long.`\n    };\n  }\n\n  return {\n    isValid: true\n  };\n}\n\nfunction guidFromClientId(clientId) {\n  const clientIdComponents = clientId.split('.').filter(component => component.includes('-'));\n  const guid = clientIdComponents[0];\n  const {\n    isValid,\n    reason\n  } = isValidGUID(guid);\n\n  if (!isValid) {\n    throw new CodedError('ERR_GOOGLE_GUID', reason + ' Please ensure you copied the client ID correctly.');\n  }\n\n  return guid;\n}\n\nexport async function logInAsync(config) {\n  if (config.behavior !== undefined) {\n    console.warn(\"Deprecated: Native Google Sign-In has been moved to Expo.GoogleSignIn ('expo-google-sign-in') Falling back to `web` behavior. `behavior` deprecated in SDK 34\");\n  }\n\n  if (config.webClientId !== undefined) {\n    console.warn('Deprecated: You will need to use expo-google-sign-in to do server side authentication outside of the Expo client');\n  }\n\n  const userDefinedScopes = config.scopes || [];\n  /* Add the required scopes for returning profile data. */\n\n  const requiredScopes = [...userDefinedScopes, 'profile', 'email', 'openid'];\n  /* Remove duplicates */\n\n  const scopes = [...new Set(requiredScopes)];\n  const guid = getPlatformGUID(config);\n  const clientId = `${guid}.apps.googleusercontent.com`;\n  const reverseClientId = `com.googleusercontent.apps.${guid}`;\n  let redirectUrl;\n\n  if (!isInExpo) {\n    redirectUrl = config.redirectUrl || `${reverseClientId}:/oauth2redirect/google`;\n  }\n\n  try {\n    const logInResult = await AppAuth.authAsync({\n      issuer: 'https://accounts.google.com',\n      scopes,\n      redirectUrl,\n      clientId\n    }); // Web login only returns an accessToken so use it to fetch the same info as the native login\n    // does.\n\n    const userInfoResponse = await fetch('https://www.googleapis.com/userinfo/v2/me', {\n      headers: {\n        Authorization: `Bearer ${logInResult.accessToken}`\n      }\n    });\n    const userInfo = await userInfoResponse.json();\n    return {\n      type: 'success',\n      accessToken: logInResult.accessToken,\n      idToken: logInResult.idToken,\n      refreshToken: logInResult.refreshToken,\n      user: {\n        id: userInfo.id,\n        name: userInfo.name,\n        givenName: userInfo.given_name,\n        familyName: userInfo.family_name,\n        photoUrl: userInfo.picture,\n        email: userInfo.email\n      }\n    };\n  } catch (error) {\n    if (error.message.toLowerCase().indexOf('user cancelled') > -1) {\n      return {\n        type: 'cancel'\n      };\n    }\n\n    throw error;\n  }\n}\nexport async function logOutAsync({\n  accessToken,\n  ...inputConfig\n}) {\n  const guid = getPlatformGUID(inputConfig);\n  const clientId = `${guid}.apps.googleusercontent.com`;\n  const config = {\n    issuer: 'https://accounts.google.com',\n    clientId\n  };\n  return await AppAuth.revokeAsync(config, {\n    token: accessToken,\n    isClientIdProvided: !!clientId\n  });\n}","map":{"version":3,"sources":["../src/Google.ts"],"names":[],"mappings":"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","sourcesContent":["import * as AppAuth from 'expo-app-auth';\nimport { CodedError } from '@unimodules/core';\nimport { Platform } from 'react-native';\nimport Constants from 'expo-constants';\n\nconst isInExpo = Constants.appOwnership === 'expo';\nexport type GoogleLogInConfig = {\n  androidClientId?: string;\n  iosClientId?: string;\n  androidStandaloneAppClientId?: string;\n  iosStandaloneAppClientId?: string;\n  /** Deprecated: You will need to use expo-google-sign-in to do server side authentication outside of the Expo client */\n  webClientId?: string;\n  /**\n   * System authentication is very different from web auth.\n   * All system functionality has been moved to expo-google-sign-in\n   */\n  behavior?: 'system' | 'web';\n  scopes?: string[];\n  /**\n   * Optionally you can define your own redirect URL.\n   * If this isn't defined then it will be infered from the correct client ID.\n   */\n  redirectUrl?: string;\n  /* If no other client IDs are defined this will be used. */\n  clientId: string;\n};\n\nexport type GoogleUser = {\n  id?: string;\n  name?: string;\n  givenName?: string;\n  familyName?: string;\n  photoUrl?: string;\n  email?: string;\n};\n\nexport type LogInResult =\n  | {\n      type: 'cancel';\n    }\n  | {\n      type: 'success';\n      accessToken: string | null;\n      idToken: string | null;\n      refreshToken: string | null;\n      user: GoogleUser;\n    };\n\nfunction getPlatformGUID(config: GoogleLogInConfig) {\n  const { clientId } = config;\n\n  const iosClientId =\n    Constants.appOwnership === 'standalone' ? config.iosStandaloneAppClientId : config.iosClientId;\n  const androidClientId = isInExpo ? config.androidClientId : config.androidStandaloneAppClientId;\n\n  const platformClientId =\n    Platform.select({\n      ios: iosClientId,\n      android: androidClientId,\n      default: config.clientId,\n    }) || clientId;\n\n  if (\n    typeof iosClientId === 'string' &&\n    typeof androidClientId === 'string' &&\n    iosClientId === androidClientId\n  ) {\n    throw new CodedError(\n      'ERR_GOOGLE_CONFIG',\n      'Keys for Android and iOS cannot be the same value. Ensure you are linking the client IDs matching the given platforms in the Google APIs console: https://console.developers.google.com/apis/credentials'\n    );\n  }\n\n  const guid = guidFromClientId(platformClientId);\n  return guid;\n}\n\n// TODO: Bacon: ensure this is valid for all cases.\nconst PROJECT_NUMBER_LENGTH = 11;\n\nconst PROJECT_ID_LENGTH = 32;\n\nfunction isValidGUID(guid: string) {\n  const components = guid.split('-');\n  if (components.length !== 2) {\n    return {\n      isValid: false,\n      reason: `\\`${guid}\\` must be a string of numbers and an alphanumeric string ${PROJECT_ID_LENGTH} characters long, joined with a hyphen.`,\n    };\n  }\n  const projectNumber = components[0];\n  const projectId = components[1];\n  if (isNaN(+projectNumber)) {\n    const hashedProjectId = Array(PROJECT_ID_LENGTH).fill('x');\n    return {\n      isValid: false,\n      reason: `\\`${projectNumber}-${hashedProjectId}\\` project number must be a string of numbers.`,\n    };\n  }\n  if (!projectId.match('^[a-zA-Z0-9]+$')) {\n    const hashedProjectNumber = Array(projectNumber.length).fill('x');\n    return {\n      isValid: false,\n      reason: `\\`${hashedProjectNumber}-${projectId}\\` project ID must be an alphanumeric string ${PROJECT_ID_LENGTH} characters long.`,\n    };\n  }\n\n  return { isValid: true };\n}\n\nfunction guidFromClientId(clientId: string): string {\n  const clientIdComponents = clientId.split('.').filter(component => component.includes('-'));\n\n  const guid = clientIdComponents[0];\n  const { isValid, reason } = isValidGUID(guid);\n  if (!isValid) {\n    throw new CodedError(\n      'ERR_GOOGLE_GUID',\n      reason + ' Please ensure you copied the client ID correctly.'\n    );\n  }\n\n  return guid;\n}\n\nexport async function logInAsync(config: GoogleLogInConfig): Promise<LogInResult> {\n  if (config.behavior !== undefined) {\n    console.warn(\n      \"Deprecated: Native Google Sign-In has been moved to Expo.GoogleSignIn ('expo-google-sign-in') Falling back to `web` behavior. `behavior` deprecated in SDK 34\"\n    );\n  }\n\n  if (config.webClientId !== undefined) {\n    console.warn(\n      'Deprecated: You will need to use expo-google-sign-in to do server side authentication outside of the Expo client'\n    );\n  }\n\n  const userDefinedScopes = config.scopes || [];\n  /* Add the required scopes for returning profile data. */\n  const requiredScopes = [...userDefinedScopes, 'profile', 'email', 'openid'];\n  /* Remove duplicates */\n  const scopes = [...new Set(requiredScopes)];\n\n  const guid = getPlatformGUID(config);\n\n  const clientId = `${guid}.apps.googleusercontent.com`;\n  const reverseClientId = `com.googleusercontent.apps.${guid}`;\n  let redirectUrl;\n  if (!isInExpo) {\n    redirectUrl = config.redirectUrl || `${reverseClientId}:/oauth2redirect/google`;\n  }\n  try {\n    const logInResult = await AppAuth.authAsync({\n      issuer: 'https://accounts.google.com',\n      scopes,\n      redirectUrl,\n      clientId,\n    });\n\n    // Web login only returns an accessToken so use it to fetch the same info as the native login\n    // does.\n    const userInfoResponse = await fetch('https://www.googleapis.com/userinfo/v2/me', {\n      headers: { Authorization: `Bearer ${logInResult.accessToken}` },\n    });\n    const userInfo = await userInfoResponse.json();\n\n    return {\n      type: 'success',\n      accessToken: logInResult.accessToken,\n      idToken: logInResult.idToken,\n      refreshToken: logInResult.refreshToken,\n      user: {\n        id: userInfo.id,\n        name: userInfo.name,\n        givenName: userInfo.given_name,\n        familyName: userInfo.family_name,\n        photoUrl: userInfo.picture,\n        email: userInfo.email,\n      },\n    };\n  } catch (error) {\n    if (error.message.toLowerCase().indexOf('user cancelled') > -1) {\n      return { type: 'cancel' };\n    }\n    throw error;\n  }\n}\n\nexport async function logOutAsync({\n  accessToken,\n  ...inputConfig\n}: GoogleLogInConfig & { accessToken: string }): Promise<any> {\n  const guid = getPlatformGUID(inputConfig);\n\n  const clientId = `${guid}.apps.googleusercontent.com`;\n\n  const config = {\n    issuer: 'https://accounts.google.com',\n    clientId,\n  };\n\n  return await AppAuth.revokeAsync(config, {\n    token: accessToken,\n    isClientIdProvided: !!clientId,\n  });\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}