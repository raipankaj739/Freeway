{"ast":null,"code":"import { batchProcessAllSourcesAsync, shouldProcess } from './ProcessSources.web';\nexport async function batchResolveAllFontsAsync(element) {\n  const fontCSSStyles = await findAllFontsForDocumentAsync();\n  const styleNode = document.createElement('style');\n  element.appendChild(styleNode);\n  styleNode.appendChild(document.createTextNode(fontCSSStyles.join('\\n')));\n  return element;\n}\n\nasync function findAllFontsForDocumentAsync() {\n  const styleSheets = document.styleSheets;\n  const sheets = Array.from(styleSheets);\n  const cssRules = getCSSRules(sheets);\n  const rulesToProcess = cssRules.filter(({\n    type\n  }) => type === CSSRule.FONT_FACE_RULE).filter(({\n    style\n  }) => shouldProcess(style.getPropertyValue('src')));\n  return await Promise.all(rulesToProcess.map(item => createNewFontForCSSRule(item)));\n}\n\nasync function createNewFontForCSSRule({\n  parentStyleSheet,\n  cssText\n}) {\n  let initialURL;\n\n  if (parentStyleSheet && parentStyleSheet.href != null) {\n    initialURL = parentStyleSheet.href;\n  }\n\n  return await batchProcessAllSourcesAsync(cssText, initialURL);\n}\n\nfunction getCSSRules(styleSheets) {\n  const cssRules = [];\n\n  for (const sheet of styleSheets) {\n    try {\n      const rules = Array.from(sheet.cssRules);\n      cssRules.push(...rules);\n    } catch ({\n      message\n    }) {\n      throw new Error(`Error while reading CSS rules from ${sheet.href}: ${message}`);\n    }\n  }\n\n  return cssRules;\n}","map":{"version":3,"sources":["../../src/takeSnapshotAsync/Fonts.web.ts"],"names":[],"mappings":"AAAA,SAAS,2BAAT,EAAsC,aAAtC,QAA2D,sBAA3D;AAIA,OAAO,eAAe,yBAAf,CAAyC,OAAzC,EAA6D;AAClE,QAAM,aAAa,GAAG,MAAM,4BAA4B,EAAxD;AACA,QAAM,SAAS,GAAG,QAAQ,CAAC,aAAT,CAAuB,OAAvB,CAAlB;AACA,EAAA,OAAO,CAAC,WAAR,CAAoB,SAApB;AACA,EAAA,SAAS,CAAC,WAAV,CAAsB,QAAQ,CAAC,cAAT,CAAwB,aAAa,CAAC,IAAd,CAAmB,IAAnB,CAAxB,CAAtB;AACA,SAAO,OAAP;AACD;;AAED,eAAe,4BAAf,GAA2C;AACzC,QAAM,WAAW,GAAmB,QAAQ,CAAC,WAA7C;AACA,QAAM,MAAM,GAAU,KAAK,CAAC,IAAN,CAAW,WAAX,CAAtB;AACA,QAAM,QAAQ,GAAG,WAAW,CAAC,MAAD,CAA5B;AACA,QAAM,cAAc,GAAG,QAAQ,CAC5B,MADoB,CACb,CAAC;AAAE,IAAA;AAAF,GAAD,KAAc,IAAI,KAAK,OAAO,CAAC,cADlB,EAEpB,MAFoB,CAEb,CAAC;AAAE,IAAA;AAAF,GAAD,KAAe,aAAa,CAAC,KAAK,CAAC,gBAAN,CAAuB,KAAvB,CAAD,CAFf,CAAvB;AAIA,SAAO,MAAM,OAAO,CAAC,GAAR,CAAY,cAAc,CAAC,GAAf,CAAmB,IAAI,IAAI,uBAAuB,CAAC,IAAD,CAAlD,CAAZ,CAAb;AACD;;AAED,eAAe,uBAAf,CAAuC;AACrC,EAAA,gBADqC;AAErC,EAAA;AAFqC,CAAvC,EAGe;AACb,MAAI,UAAJ;;AACA,MAAI,gBAAgB,IAAI,gBAAgB,CAAC,IAAjB,IAAyB,IAAjD,EAAuD;AACrD,IAAA,UAAU,GAAG,gBAAgB,CAAC,IAA9B;AACD;;AACD,SAAO,MAAM,2BAA2B,CAAC,OAAD,EAAU,UAAV,CAAxC;AACD;;AAED,SAAS,WAAT,CAAqB,WAArB,EAAiD;AAC/C,QAAM,QAAQ,GAAmB,EAAjC;;AACA,OAAK,MAAM,KAAX,IAAoB,WAApB,EAAiC;AAC/B,QAAI;AACF,YAAM,KAAK,GAAU,KAAK,CAAC,IAAN,CAAW,KAAK,CAAC,QAAjB,CAArB;AACA,MAAA,QAAQ,CAAC,IAAT,CAAc,GAAG,KAAjB;AACD,KAHD,CAGE,OAAO;AAAE,MAAA;AAAF,KAAP,EAAoB;AACpB,YAAM,IAAI,KAAJ,CAAU,sCAAsC,KAAK,CAAC,IAAI,KAAK,OAAO,EAAtE,CAAN;AACD;AACF;;AACD,SAAO,QAAP;AACD","sourcesContent":["import { batchProcessAllSourcesAsync, shouldProcess } from './ProcessSources.web';\n\ndeclare var document: Document;\n\nexport async function batchResolveAllFontsAsync(element: HTMLElement): Promise<HTMLElement> {\n  const fontCSSStyles = await findAllFontsForDocumentAsync();\n  const styleNode = document.createElement('style');\n  element.appendChild(styleNode);\n  styleNode.appendChild(document.createTextNode(fontCSSStyles.join('\\n')));\n  return element;\n}\n\nasync function findAllFontsForDocumentAsync(): Promise<string[]> {\n  const styleSheets: StyleSheetList = document.styleSheets;\n  const sheets: any[] = Array.from(styleSheets);\n  const cssRules = getCSSRules(sheets);\n  const rulesToProcess = cssRules\n    .filter(({ type }) => type === CSSRule.FONT_FACE_RULE)\n    .filter(({ style }) => shouldProcess(style.getPropertyValue('src')));\n\n  return await Promise.all(rulesToProcess.map(item => createNewFontForCSSRule(item)));\n}\n\nasync function createNewFontForCSSRule({\n  parentStyleSheet,\n  cssText,\n}: CSSStyleRule): Promise<string> {\n  let initialURL;\n  if (parentStyleSheet && parentStyleSheet.href != null) {\n    initialURL = parentStyleSheet.href;\n  }\n  return await batchProcessAllSourcesAsync(cssText, initialURL);\n}\n\nfunction getCSSRules(styleSheets: CSSStyleSheet[]): CSSStyleRule[] {\n  const cssRules: CSSStyleRule[] = [];\n  for (const sheet of styleSheets) {\n    try {\n      const rules: any[] = Array.from(sheet.cssRules);\n      cssRules.push(...rules);\n    } catch ({ message }) {\n      throw new Error(`Error while reading CSS rules from ${sheet.href}: ${message}`);\n    }\n  }\n  return cssRules;\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}